---
title: "README"
author: "Edson Silva-Júnior"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Analise de desmatamento da Mata Atlântica

> Análise geoespacial do desmatamento da Mata Atlântica, segundo dados do [Terrabrasilis](https://terrabrasilis.dpi.inpe.br/downloads/)

# Pacotes 

```{r}
library(geobr)

library(tidyverse)

library(magrittr)

library(sf)

library(terra)

library(tidyterra)
```

# Dados 

## Shapefile da Mata Atlântica 

### Importando 

```{r}
ma <- geobr::read_biomes(year = 2019) |> 
  dplyr::filter(name_biome == "Mata Atlântica")
```

### Visualizando

```{r}
ma

ggplot() +
  geom_sf(data = ma, color = "darkgreen", fill = "forestgreen", alpha = 0.3)
```

## Shapefile dos estados do Mata Atlântica

### Importando 

```{r}
estados <- geobr::read_state(year = 2019)
```

### Visualizando 

```{r}
estados

ggplot() +
  geom_sf(data = estados, color = "darkgreen", fill = "forestgreen", alpha = 0.3)
```

### Tratando 

```{r}
estados_ma <- estados |> 
  sf::st_intersection(ma)

estados_ma

ggplot() +
  geom_sf(data = estados, color = "black") +
  geom_sf(data = estados_ma, color = "darkgreen", fill = "forestgreen", alpha = 0.3)
```

## Raster de desmatamento 

### Importnado 

```{r}
des_tif <- terra::rast("prodes_mata_atlantica_2024.tif")
```

### Visualizando

```{r}
des_tif

ggplot() +
  tidyterra::geom_spatraster(data = des_tif) +
  scale_fill_viridis_c(na.value = NA) +
  theme_minimal()
```

# Reamostrando o raster de desmatamento para 1km²

## Criando o raster

```{r}
raster_modelo <- rast(res = (30 / 3600), 
                      crs = "EPSG:4326",
                      ext = des_tif |> terra::ext())

raster_modelo
```

## Reamostrando

```{r}
des_tif

des_tif_rea <- des_tif |> 
  terra::resample(raster_modelo)
  
des_tif_rea

terra::res(des_tif_rea) == terra::res(des_tif)
```

## Visualizando o raster reamostrado

```{r}
des_tif_rea

ggplot() +
  tidyterra::geom_spatraster(data = des_tif_rea) +
  scale_fill_viridis_c(na.value = NA) +
  geom_sf(data = uc, color = "red", fill = NA) +
  theme_minimal()
```

# Comparação da área de desmatamento por estados

## Área dos estados

```{r}
area_estados <- estados_ma |> 
  sf::st_transform(crs = 32725) |> 
  sf::st_area() / 1e6 |> 
  as.numeric()

area_estados
```

## Área desmatada

```{r}
area_raster <- c()

area_desmatada <- function(id){
  
  raster_recortado <- des_tif_rea |>
    terra::crop(estados_ma[id, ]) |> 
    terra::mask(estados_ma[id, ]) |> 
    tidyterra::filter(prodes_mata_atlantica_2024 < 50)
  
  area <- raster_recortado |> terra::expanse(unit = "km")
  
  area_raster <<- c(area_raster, area[1, 2]) 
  
}

n_estados <- estados_ma |> nrow()

n_estados

purrr::walk(1:n_estados, area_desmatada)

area_raster
```

## Incorporando os dados ao shapefile 

```{r}
estados_area <- estados_ma |> 
  dplyr::mutate(`Área desmatada` = area_raster,
                `% de área desmatada do estado` = area_raster / area_estados |>
                  as.numeric())

estados_area
```

## Visualizando os mapas

```{r}
ggplot() +
  geom_sf(data = estados, color = "black") +
  geom_sf(data = estados_area, 
          color = "black", aes(fill = `Área desmatada`)) +
  scale_fill_viridis_c(na.value = NA,
                       guide = guide_colourbar(title.position = "top",
                                               title.hjust = 0.5,
                                               barwidth = 20,
                                               barheight = 0.75,
                                               frame.colour = "black",
                                               ticks.colour = "black")) +
  theme_minimal() +
  theme(legend.position = "bottom")

ggplot() +
  geom_sf(data = estados, color = "black") +
  geom_sf(data = estados_area, 
          color = "black", aes(fill = `% de área desmatada do estado`)) +
  scale_fill_viridis_c(na.value = NA,
                       guide = guide_colourbar(title.position = "top",
                                               title.hjust = 0.5,
                                               barwidth = 20,
                                               barheight = 0.75,
                                               frame.colour = "black",
                                               ticks.colour = "black")) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

